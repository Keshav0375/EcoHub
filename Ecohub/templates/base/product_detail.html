{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - EcoTech Hub{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'products:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'products:list' %}">Products</a></li>
            <li class="breadcrumb-item active">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Product Images -->
        <div class="col-lg-6">
            <div class="card border-0">
                {% if product.images.exists %}
                    <div id="productImageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner rounded">
                            {% for image in product.images.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ image.image.url }}" class="d-block w-100" 
                                     alt="{{ image.alt_text }}" style="height: 400px; object-fit: cover;">
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if product.images.count > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#productImageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#productImageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                        <i class="fas fa-image text-muted display-1"></i>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-lg-6">
            <div class="ps-lg-4">
                <h1 class="h2 mb-2">{{ product.name }}</h1>
                <p class="text-muted mb-3">by <strong>{{ product.vendor.company_name }}</strong></p>

                <!-- Rating and Reviews -->
                <div class="d-flex align-items-center mb-3">
                    <div class="text-warning me-2">
                        {% for i in "12345" %}
                            {% if forloop.counter <= product.average_rating %}
                                <i class="fas fa-star"></i>
                            {% else %}
                                <i class="far fa-star"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="text-muted">({{ product.review_count }} reviews)</span>
                </div>

                <!-- Price -->
                <div class="mb-4">
                    {% if product.discounted_price %}
                        <div class="d-flex align-items-center">
                            <span class="h3 text-success fw-bold me-3">${{ product.discounted_price }}</span>
                            <span class="h5 text-decoration-line-through text-muted">${{ product.price }}</span>
                            <span class="badge bg-danger ms-2">
                                {% widthratio product.price|floatformat:0|sub:product.discounted_price|floatformat:0 product.price|floatformat:0 100 %}% OFF
                            </span>
                        </div>
                    {% else %}
                        <span class="h3 text-success fw-bold">${{ product.price }}</span>
                    {% endif %}
                </div>

                <!-- Environmental Metrics -->
                <div class="card bg-light border-0 mb-4">
                    <div class="card-body">
                        <h6 class="fw-bold text-success mb-3">
                            <i class="fas fa-leaf me-2"></i>Environmental Impact
                        </h6>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2">{{ product.energy_efficiency_rating }}</span>
                                    <small class="text-muted">Energy Rating</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="text-center">
                                    <div class="fw-bold text-success">{{ product.carbon_footprint }} kg</div>
                                    <small class="text-muted">CO2/year</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-primary">{{ product.energy_consumption }} kWh</div>
                                    <small class="text-muted">Energy/year</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-warning">{{ product.recyclable_percentage }}%</div>
                                    <small class="text-muted">Recyclable</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Certifications -->
                {% if product.certifications %}
                <div class="mb-4">
                    <h6 class="fw-bold">
                        <i class="fas fa-certificate me-2"></i>Certifications
                    </h6>
                    <span class="badge bg-warning text-dark">{{ product.get_certifications_display }}</span>
                </div>
                {% endif %}

                <!-- Availability -->
                <div class="mb-4">
                    {% if product.availability > 0 %}
                        <div class="text-success">
                            <i class="fas fa-check-circle me-2"></i>
                            In Stock ({{ product.availability }} available)
                        </div>
                    {% else %}
                        <div class="text-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            Out of Stock
                        </div>
                    {% endif %}
                </div>

                <!-- Warranty -->
                <div class="mb-4">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt me-2"></i>
                        {{ product.warranty_years }} year{% if product.warranty_years > 1 %}s{% endif %} warranty included
                    </small>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    {% if product.availability > 0 %}
                        <button class="btn btn-success btn-lg">
                            <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                        </button>
                        <button class="btn btn-outline-success">
                            <i class="fas fa-heart me-2"></i>Add to Wishlist
                        </button>
                    {% else %}
                        <button class="btn btn-secondary btn-lg" disabled>
                            <i class="fas fa-times me-2"></i>Out of Stock
                        </button>
                        <button class="btn btn-outline-success">
                            <i class="fas fa-bell me-2"></i>Notify When Available
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details Tabs -->
    <div class="row mt-5">
        <div class="col-12">
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active" id="nav-description-tab" data-bs-toggle="tab" 
                            data-bs-target="#nav-description" type="button" role="tab">
                        Description
                    </button>
                    <button class="nav-link" id="nav-specifications-tab" data-bs-toggle="tab" 
                            data-bs-target="#nav-specifications" type="button" role="tab">
                        Specifications
                    </button>
                    <button class="nav-link" id="nav-reviews-tab" data-bs-toggle="tab" 
                            data-bs-target="#nav-reviews" type="button" role="tab">
                        Reviews ({{ product.review_count }})
                    </button>
                    <button class="nav-link" id="nav-vendor-tab" data-bs-toggle="tab" 
                            data-bs-target="#nav-vendor" type="button" role="tab">
                        Vendor Info
                    </button>
                </div>
            </nav>
            
            <div class="tab-content" id="nav-tabContent">
                <!-- Description -->
                <div class="tab-pane fade show active" id="nav-description" role="tabpanel">
                    <div class="py-4">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Product Description</h5>
                                <p>{{ product.description|linebreaks }}</p>
                                
                                <h6 class="mt-4">Environmental Benefits</h6>
                                <ul>
                                    <li>Reduces energy consumption by up to 30% compared to traditional alternatives</li>
                                    <li>{{ product.recyclable_percentage }}% of materials are recyclable</li>
                                    <li>Estimated carbon footprint reduction of {{ product.carbon_footprint }} kg CO2 annually</li>
                                    {% if product.certifications %}
                                    <li>{{ product.get_certifications_display }} certified for sustainability</li>
                                    {% endif %}
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <h6>Calculate Your Savings</h6>
                                        <p class="small text-muted">See how much you can save with this eco-friendly product</p>
                                        <a href="{% url 'products:impact_calculator' %}" class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-calculator me-2"></i>Calculate Impact
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Specifications -->
                <div class="tab-pane fade" id="nav-specifications" role="tabpanel">
                    <div class="py-4">
                        <h5>Technical Specifications</h5>
                        {% if product.specifications %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    {% for key, value in product.specifications.items %}
                                    <tr>
                                        <td class="fw-bold">{{ key|capfirst }}</td>
                                        <td>{{ value }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No detailed specifications available.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Reviews -->
                <div class="tab-pane fade" id="nav-reviews" role="tabpanel">
                    <div class="py-4">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="display-4 text-success">{{ product.average_rating|default:"0.0" }}</div>
                                    <div class="text-warning mb-2">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= product.average_rating %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <p class="text-muted">Based on {{ product.review_count }} reviews</p>
                                </div>
                            </div>
                            <div class="col-md-8">
                                {% if product.reviews.exists %}
                                    {% for review in product.reviews.all|slice:":3" %}
                                    <div class="border-bottom py-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong>{{ review.user.get_full_name|default:review.user.username }}</strong>
                                                <div class="text-warning small">
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= review.overall_rating %}
                                                            <i class="fas fa-star"></i>
                                                        {% else %}
                                                            <i class="far fa-star"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                                        </div>
                                        <h6>{{ review.title }}</h6>
                                        <p class="small">{{ review.comment }}</p>
                                        {% if review.would_recommend %}
                                        <small class="text-success">
                                            <i class="fas fa-thumbs-up me-1"></i>Recommends this product
                                        </small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No reviews yet. Be the first to review this product!</p>
                                {% endif %}
                                
                                <div class="mt-3">
                                    <button class="btn btn-outline-success">Write a Review</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendor Info -->
                <div class="tab-pane fade" id="nav-vendor" role="tabpanel">
                    <div class="py-4">
                        <div class="row">
                            <div class="col-md-3">
                                {% if product.vendor.logo %}
                                    <img src="{{ product.vendor.logo.url }}" class="img-fluid rounded" alt="{{ product.vendor.company_name }}">
                                {% else %}
                                    <div class="bg-light rounded p-4 text-center">
                                        <i class="fas fa-store display-4 text-muted"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-9">
                                <h5>{{ product.vendor.company_name }}</h5>
                                <p>{{ product.vendor.description }}</p>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Vendor Rating</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="h6 text-success">{{ product.vendor.rating|floatformat:1 }}</span>
                                            <div class="text-warning ms-2">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= product.vendor.rating %}
                                                        <i class="fas fa-star"></i>
                                                    {% else %}
                                                        <i class="far fa-star"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Eco Impact Score</h6>
                                        <span class="h6 text-success">{{ product.vendor.eco_impact_score|floatformat:1 }}/10</span>
                                    </div>
                                </div>
                                
                                {% if product.vendor.verification_status == 'verified' %}
                                <div class="mt-3">
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>Verified Sustainable Vendor
                                    </span>
                                </div>
                                {% endif %}
                                
                                <div class="mt-3">
                                    <a href="{% url 'vendors:detail' product.vendor.pk %}" class="btn btn-outline-success">
                                        View Vendor Profile
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div class="row mt-5">
        <div class="col-12">
            <h4 class="mb-4">Related Products</h4>
            <div class="row g-4">
                {% for related_product in related_products %}
                <div class="col-md-3">
                    <div class="card h-100 shadow-sm border-0">
                        {% if related_product.images.first %}
                            <img src="{{ related_product.images.first.image.url }}" 
                                 class="card-img-top" alt="{{ related_product.images.first.alt_text }}" 
                                 style="height: 150px; object-fit: cover;">
                        {% else %}
                            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 150px;">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        {% endif %}
                        
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">{{ related_product.name|truncatechars:40 }}</h6>
                            <div class="mt-auto">
                                <div class="text-success fw-bold">${{ related_product.final_price }}</div>
                                <a href="{% url 'products:detail' related_product.slug %}" class="btn btn-outline-success btn-sm mt-2">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
